<!doctype html><html><head><title>Adding a service</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://marblerun.sh/docs/workflows/add-service/><link rel=stylesheet href=https://marblerun.sh/scss/bootstrap.min.b34363dc2fd8ff214ebdc9fc5affef728cbcf6271a9be12263a2904a48f10509.css emotion=ðŸ¤©><script defer src=https://use.fontawesome.com/releases/v5.10.2/js/all.js></script><script async defer src=https://buttons.github.io/buttons.js></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="Marblerun - The service mesh for confidential computing"><meta property="og:description" content="Marblerun makes it easy to deploy, scale, and verify your SGX-based apps on vanilla Kubernetes. Think Istio/Consul/Linkerd for confidential computing.â€‹"><meta property="og:image" content="https://www.marblerun.sh/img/social.png"><meta name=twitter:title content="Marblerun - The service mesh for confidential computing"><meta name=twitter:description content="Marblerun makes it easy to deploy, scale, and verify your SGX-based apps on vanilla Kubernetes."><meta name=twitter:image content="https://www.marblerun.sh/img/social.png"><meta name=twitter:card content="Marblerun"></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top container-fluid"><a class=navbar-brand href=/><img src=/img/logo.png width=140px></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/docs/introduction/><i class="fas fa-book"></i>&nbsp;Docs</a></li><li class=nav-item><a class=nav-link href=/community><i class="fas fa-comments"></i>&nbsp;Community</a></li><li class=nav-item><a class=nav-link href=https://github.com/edgelesssys/marblerun><i class="fab fa-github"></i>&nbsp;GitHub</a></li><li class=nav-item><a href=/docs/getting-started/quickstart class="nav-link btn btn-primary ml-3">Get started â†’</a></li></ul></div></nav><div class="container my-3"><h1 class=my-3>Docs</h1><div class=row><div class="col-12 col-lg-3"><div class=docsSidebar><div class=mb-3><a href=/docs/introduction/ class=d-block>Introduction</a></div><div class=mb-3><h6>Getting Started</h6><a href=/docs/getting-started/quickstart/ class=d-block>Quickstart</a>
<a href=/docs/getting-started/concepts/ class=d-block>Concepts</a>
<a href=/docs/getting-started/coordinator/ class=d-block>Coordinator</a>
<a href=/docs/getting-started/marbles/ class=d-block>Marbles</a>
<a href=/docs/getting-started/cli/ class=d-block>CLI</a>
<a href=/docs/getting-started/sgx-device-plugin/ class=d-block>SGX device plugin</a></div><div class=mb-3><h6>Features</h6><a href=/docs/features/attestation/ class=d-block>Attestation</a>
<a href=/docs/features/recovery/ class=d-block>Recovery</a>
<a href=/docs/features/secrets-management/ class=d-block>Secrets management</a>
<a href=/docs/features/auto-injection/ class=d-block>Kubernetes integration</a>
<a href=/docs/features/runtimes/ class=d-block>Supported runtimes</a>
<a href=/docs/features/planned-features/ class=d-block>Planned features</a></div><div class=mb-3><h6>Core workflows</h6><a href=/docs/workflows/deploy/ class=d-block>Deploying Marblerun</a>
<a href=/docs/workflows/define-manifest/ class=d-block>Defining a Manifest</a>
<a href=/docs/workflows/set-manifest/ class=d-block>Setting a Manifest</a>
<a href=/docs/workflows/add-service/ class="d-block text-primary">> Adding a service</a>
<a href=/docs/workflows/verification/ class=d-block>Verifying a deployment</a></div><div class=mb-3><h6>Additional workflows</h6><a href=/docs/additional-workflows/monitoring/ class=d-block>Monitoring and logging</a>
<a href=/docs/additional-workflows/update-manifest/ class=d-block>Updating a Manifest</a>
<a href=/docs/additional-workflows/updates/ class=d-block>Updating a deployment</a>
<a href=/docs/additional-workflows/recover-coordinator/ class=d-block>Recovering the Coordinator</a></div><div class=mb-3><h6>Building services</h6><a href=/docs/building-services/ego/ class=d-block>EGo</a>
<a href=/docs/building-services/graphene/ class=d-block>Graphene</a></div><div class=mb-3><h6>Examples</h6><a href=/docs/examples/helloworld/ class=d-block>Hello world</a>
<a href=/docs/examples/emojivoto/ class=d-block>Emoji voting</a>
<a href=/docs/examples/graphene/ class=d-block>Graphene-based examples</a></div><div class=mb-3><a href=/docs/changelog/ class=d-block>Changelog</a></div></div></div><div class="col-12 col-lg-9"><article><h1 id=adding-a-service>Adding a service</h1><p>Adding a service to your application requires three steps, which are described in the following.</p><h2 id=step-1-get-your-service-ready-for-marblerun><strong>Step 1:</strong> Get your service ready for Marblerun</h2><p>To get your service ready for Marblerun, you need to rebuild it with one of the supported <a href=https://marblerun.sh/docs/features/runtimes/>runtimes</a>:</p><ul><li><a href=https://marblerun.sh/docs/building-services/ego/>EGo</a></li><li><a href=https://github.com/edgelesssys/marblerun/blob/master/samples/helloc%2B%2B>Edgeless RT</a></li><li><a href=https://marblerun.sh/docs/building-services/graphene/>Graphene</a></li></ul><h3 id=make-your-service-use-the-provided-tls-credentials>Make your service use the provided TLS credentials</h3><p>Quick refresher: Marblerun&rsquo;s Coordinator issues TLS credentials for each verified Marble (i.e., a service running in a secure enclave) as is described in our <a href=https://marblerun.sh/docs/features/secrets-management/#tls-credentials>secrets management chapter</a>.</p><p>The TLS X.509 certificate and the corresponding private key can be securely passed to a service through files, environments variables, or commandline arguments. This is defined in the Manifest as is described in our <a href=https://marblerun.sh/docs/workflows/define-manifest/#manifestmarbles>writing a manifest hands-on</a>.</p><p>For now, you just need to make sure that your service reads the certificate and the private key from arbitrary paths, environment variables, or commandline arguments, e.g., the file <code>/tmp/mycert.cert</code> or the environment variable <code>MY_PRIVATE_KEY</code>, and uses them at runtime for internal and external connections. If you&rsquo;re lucky, your service already does this and you don&rsquo;t need to change a thing in the code.</p><h2 id=step-2-define-your-service-in-the-manifest><strong>Step 2:</strong> Define your service in the Manifest</h2><p>Now that your service is ready, you need to make two types of entries in the Manifest regarding its properties and parameters.</p><h3 id=step-21-define-the-enclave-software-package><strong>Step 2.1:</strong> Define the enclave software-package</h3><p>As is described in more detail in our <a href=https://marblerun.sh/docs/workflows/define-manifest/#manifestpackages>writing a manifest hands-on</a>, the Manifest contains a section <code>Packages</code>, in which allowed enclave software-packages are defined.</p><p>To add an entry for your service, run the <code>oesign</code> tool on the enclave file you built in the previous step as follows. (<code>oesign</code> is installed with <a href=https://github.com/edgelesssys/edgelessrt>Edgeless RT</a>.)</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>oesign eradump -e enclave.signed
</code></pre></div><p>The tool&rsquo;s output will look like the following.</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#309;font-weight:700>&#34;UniqueID&#34;</span>: <span style=color:#c30>&#34;6b2822ac2585040d4b9397675d54977a71ef292ab5b3c0a6acceca26074ae585&#34;</span>,
    <span style=color:#309;font-weight:700>&#34;SignerID&#34;</span>: <span style=color:#c30>&#34;5826218dbe96de0d7b3b1ccf70ece51457e71e886a3d4c1f18b27576d22cdc74&#34;</span>,
    <span style=color:#309;font-weight:700>&#34;SecurityVersion&#34;</span>: <span style=color:#f60>1</span>,
    <span style=color:#309;font-weight:700>&#34;ProductID&#34;</span>: <span style=color:#f60>3</span>
}
</code></pre></div><p>Use <code>UniqueID</code> (i.e., <code>MRENCLAVE</code> in Intel SGX speak) or the triplet of <code>SignerID</code> (i.e., <code>MRSIGNER</code>), <code>SecurityVersion</code>, and <code>ProductID</code> to add an entry in the <code>Packages</code> section.</p><h3 id=step-22-define-the-parameters><strong>Step 2.2:</strong> Define the parameters</h3><p>Now you can define with which parameters (i.e., files, environments variables, and command line arguments) your service is allowed to run. This is done in the <code>Marbles</code> section of the Manifest as is described in our <a href=https://marblerun.sh/docs/workflows/define-manifest/#manifestmarbles>writing a manifest hands-on</a>. As discussed in <a href=#step-11-make-your-service-use-the-provided-tls-credentials>Step #1.1</a>, you need to make sure that the TLS credentials for your service (i.e., <code>Marblerun.MarbleCert.Cert</code> and <code>Marblerun.MarbleCert.Private</code>) are injected such that your service will find them at runtime. If your service is written in Go and you&rsquo;re using the <code>marble</code> package, there is no need to inject these explicitly.</p><h2 id=step-3-start-your-service><strong>Step 3:</strong> Start your service</h2><p>When you start your service, you need to pass in a couple of configuration parameters through environment variables. Here is an example:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#033>EDG_MARBLE_COORDINATOR_ADDR</span><span style=color:#555>=</span>coordinator-mesh-api.marblerun:2001 <span style=color:#033>EDG_MARBLE_TYPE</span><span style=color:#555>=</span>mymarble <span style=color:#033>EDG_MARBLE_UUID_FILE</span><span style=color:#555>=</span><span style=color:#033>$PWD</span>/uuid <span style=color:#033>EDG_MARBLE_DNS_NAMES</span><span style=color:#555>=</span>localhost,myservice erthost enclave.signed
</code></pre></div><p><code>erthost</code> is the generic host for Marbles, which will load your <code>enclave.signed</code>. The environment variables have the following purposes.</p><ul><li><p><code>EDG_MARBLE_COORDINATOR_ADDR</code> is the network address of the Coordinator&rsquo;s API for Marbles. When you deploy the Coordinator using our Helm repository as is described in our <a href=https://marblerun.sh/docs/workflows/deploy/>deploying Marblerun hands-on</a>, the default address is <code>coordinator-mesh-api.marblerun:2001</code>.</p></li><li><p><code>EDG_MARBLE_TYPE</code> needs to reference one entry from your Manifest&rsquo;s <code>Marbles</code> section.</p></li><li><p><code>EDG_MARBLE_UUID_FILE</code> is the local file path where the Marble stores its UUID. Every instance of a Marble has its unique and public UUID. The file is needed to allow a Marble to restart under its UUID.</p></li><li><p><code>EDG_MARBLE_DNS_NAMES</code> is the list of DNS names the Coordinator will issue the Marble&rsquo;s certificate for.</p></li></ul><h2 id=step-4-deploy-your-service-with-kubernetes><strong>Step 4:</strong> Deploy your service with Kubernetes</h2><p>Typically, you&rsquo;ll write a Kubernetes resource definition for your service, which you&rsquo;ll deploy with the Kubernetes CLI, Helm, or similar tools.</p><p>For your services to take advantage of Marblerun, they need to be &ldquo;added to the mesh&rdquo; by having the data plane configuration injected into their pods.
This is typically done by labeling the namespace, deployment, or pod with the <code>marblerun/inject=enabled</code> Kubernetes label.
This label triggers automatic configuration injection when the resources are created. (See the <a href=https://marblerun.sh/docs/features/auto-injection/>auto injection page</a> for more on how this works.)
Alternatively, you can enable a namespace for auto-injection using the Marblerun CLI:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>marblerun namespace add NAMESPACE <span style=color:#555>[</span>--no-sgx-injection<span style=color:#555>]</span>
</code></pre></div><p>In order for our injection service to know which type of Marble your service corresponds to, you also need to add the <code>marblerun/marbletype</code> Kubernetes label.
An example for a Marble of type <code>web</code> could look like this:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#309;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#309;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#309;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#309;font-weight:700>name</span>:<span style=color:#bbb> </span>web<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#309;font-weight:700>namespace</span>:<span style=color:#bbb> </span>emojivoto<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#309;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#309;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>web<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#309;font-weight:700>app.kubernetes.io/part-of</span>:<span style=color:#bbb> </span>emojivoto<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#309;font-weight:700>app.kubernetes.io/version</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#309;font-weight:700>marblerun/inject</span>:<span style=color:#bbb> </span>enabled<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#309;font-weight:700>marblerun/marbletype</span>:<span style=color:#bbb> </span>web<span style=color:#bbb>
</span></code></pre></div><p>This will result in the following configuration being injected when your resources are created:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#309;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#309;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:#309;font-weight:700>env</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:#309;font-weight:700>name</span>:<span style=color:#bbb> </span>EDG_MARBLE_COORDINATOR_ADDR<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#309;font-weight:700>value</span>:<span style=color:#bbb> </span>coordinator-mesh-api.marblerun:2001<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:#309;font-weight:700>name</span>:<span style=color:#bbb> </span>EDG_MARBLE_TYPE<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#309;font-weight:700>value</span>:<span style=color:#bbb> </span>web<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:#309;font-weight:700>name</span>:<span style=color:#bbb> </span>EDG_MARBLE_DNS_NAMES<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#309;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#c30>&#34;web,web.emojivoto,web.emojivoto.svc.cluster.local&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:#309;font-weight:700>name</span>:<span style=color:#bbb> </span>EDG_MARBLE_UUID_FILE<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#309;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#c30>&#34;$PWD/uuid&#34;</span><span style=color:#bbb>
</span></code></pre></div><p>Refer to our <a href=https://github.com/edgelesssys/emojivoto>emojivoto</a> app for complete Helm chart examples.</p></article></div></div></div><footer class="bg-light text-center p-3"><div>Marblerun is brought to you by <a target=_blank href=https://edgeless.systems/>Edgeless Systems GmbH <img src=/img/ES_Symbol_black.svg class="verticle-align-middle ml-2" alt="Edgeless Systems GmbH Logo" width=14px class=mb-3></a></div></footer><script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx crossorigin=anonymous></script><script src=/js/main.js></script></body></html>