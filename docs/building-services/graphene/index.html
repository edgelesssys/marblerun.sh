<!doctype html><html><head><title>Graphene</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://marblerun.sh/docs/building-services/graphene/><link rel=stylesheet href=https://marblerun.sh/scss/bootstrap.min.462c371c7334fb8be9e57eb1edffd6d85726378c54b9e9c7135419c4a0a7f0b9.css emotion=ðŸ¤©><script defer src=https://use.fontawesome.com/releases/v5.10.2/js/all.js></script><script async defer src=https://buttons.github.io/buttons.js></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="Marblerun - The control plane for confidential computing"><meta property="og:description" content="Marblerun makes it easy to deploy, scale, and verify your SGX-based apps on vanilla Kubernetes. Think Istio/Consul/Linkerd for confidential computing.â€‹"><meta property="og:image" content="https://www.marblerun.sh/img/social.png"><meta name=twitter:title content="Marblerun - The control plane for confidential computing"><meta name=twitter:description content="Marblerun makes it easy to deploy, scale, and verify your SGX-based apps on vanilla Kubernetes."><meta name=twitter:image content="https://www.marblerun.sh/img/social.png"><meta name=twitter:card content="Marblerun"></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top container-fluid"><a class=navbar-brand href=/><img src=/img/logo.png width=140px></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/docs/introduction/><i class="fas fa-book"></i>&nbsp;Docs</a></li><li class=nav-item><a class=nav-link href=/community><i class="fas fa-comments"></i>&nbsp;Community</a></li><li class=nav-item><a class=nav-link href=https://github.com/edgelesssys/marblerun><i class="fab fa-github"></i>&nbsp;GitHub</a></li><li class=nav-item><a href=/docs/getting-started/quickstart class="nav-link btn btn-primary ml-3">Get started â†’</a></li></ul></div></nav><div class="container my-3"><div class=row><div class="col-12 col-lg-3"><div class=docsSidebar><h1 class=my-3>Docs</h1><div class=mb-3><a href=/docs/introduction/ class=d-block><h6>Introduction</h6></a></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse1>Getting Started</h6><div class=collapse id=collapse1><a href=/docs/getting-started/quickstart/ class=d-block>Quickstart</a>
<a href=/docs/getting-started/concepts/ class=d-block>Concepts</a>
<a href=/docs/getting-started/coordinator/ class=d-block>Coordinator</a>
<a href=/docs/getting-started/marbles/ class=d-block>Marbles</a>
<a href=/docs/getting-started/cli/ class=d-block>CLI</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse2>Features</h6><div class=collapse id=collapse2><a href=/docs/features/attestation/ class=d-block>Attestation</a>
<a href=/docs/features/recovery/ class=d-block>Recovery</a>
<a href=/docs/features/secrets-management/ class=d-block>Secrets management</a>
<a href=/docs/features/auto-injection/ class=d-block>Kubernetes integration</a>
<a href=/docs/features/runtimes/ class=d-block>Supported runtimes</a>
<a href=/docs/features/planned-features/ class=d-block>Planned features</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse3>Deployment</h6><div class=collapse id=collapse3><a href=/docs/deployment/cloud/ class=d-block>Cloud</a>
<a href=/docs/deployment/on-prem/ class=d-block>On-premises</a>
<a href=/docs/deployment/kubernetes/ class=d-block>Kubernetes</a>
<a href=/docs/deployment/standalone/ class=d-block>Standalone</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse4>Core workflows</h6><div class=collapse id=collapse4><a href=/docs/workflows/define-manifest/ class=d-block>Defining a Manifest</a>
<a href=/docs/workflows/set-manifest/ class=d-block>Setting a Manifest</a>
<a href=/docs/workflows/add-service/ class=d-block>Adding a service</a>
<a href=/docs/workflows/verification/ class=d-block>Verifying a deployment</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse5>Additional workflows</h6><div class=collapse id=collapse5><a href=/docs/additional-workflows/monitoring/ class=d-block>Monitoring and logging</a>
<a href=/docs/additional-workflows/update-manifest/ class=d-block>Updating a Manifest</a>
<a href=/docs/additional-workflows/updates/ class=d-block>Updating a deployment</a>
<a href=/docs/additional-workflows/recover-coordinator/ class=d-block>Recovering the Coordinator</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse6>Building services</h6><div class="collapse show" id=collapse6><a href=/docs/building-services/ego/ class=d-block>EGo</a>
<a href=/docs/building-services/graphene/ class="d-block text-primary">> Graphene</a>
<a href=/docs/building-services/occlum/ class=d-block>Occlum</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse7>Examples</h6><div class=collapse id=collapse7><a href=/docs/examples/helloworld/ class=d-block>Hello world</a>
<a href=/docs/examples/emojivoto/ class=d-block>Emoji voting</a>
<a href=/docs/examples/graphene/ class=d-block>Graphene-based examples</a>
<a href=/docs/examples/occlum/ class=d-block>Occlum-based examples</a></div></div><div class=mb-3><a href=/docs/changelog/ class=d-block><h6>Changelog</h6></a></div></div></div><div class="col-12 col-lg-9"><article><h1 id=building-a-service-graphene>Building a service: Graphene</h1><p>Running a Graphene app with Marblerun requires some changes to its manifest. These are explained in the following. See also the <a href=https://marblerun.sh/docs/examples/graphene/>helloworld example</a>.</p><h2 id=requirements>Requirements</h2><p>First, get Graphene up and running. You can use either the <a href=https://graphene.readthedocs.io/en/latest/building.html>Building</a> or <a href=https://graphene.readthedocs.io/en/latest/cloud-deployment.html>Cloud Deployment</a> guide to build and initially setup Graphene.</p><p>Before running your application, make sure you got the prerequisites for ECDSA remote attestation installed on your system. You can collectively install them with the following command:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo apt install libsgx-quote-ex-dev
</code></pre></div><h2 id=configuration>Configuration</h2><h3 id=entrypoint-and-argv>Entrypoint and argv</h3><p>We provide the <code>premain-graphene</code> executable with the <a href=https://github.com/edgelesssys/marblerun/releases>Marblerun Releases</a>. It will contact the Coordinator, set up the environment, and run the actual application.</p><p>Set the premain executable as the entry point of the Graphene project and place the actual entry point in argv0:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>libos.entrypoint = <span style=color:#c30>&#34;file:premain-graphene&#34;</span>
sgx.trusted_files.premain = <span style=color:#c30>&#34;file:premain-graphene&#34;</span>

<span style=color:#09f;font-style:italic># argv0 needs to contain the name of your executable</span>
loader.argv0_override = <span style=color:#c30>&#34;hello&#34;</span>
</code></pre></div><p>After the premain is done running, it will automatically spawn your application.</p><p>For a better illustration on the differences between the two premain variants, check out our <a href=https://github.com/edgelesssys/marblerun/tree/master/samples/graphene-hello>&ldquo;Hello World&rdquo; sample on GitHub.</a></p><h3 id=host-environment-variables>Host environment variables</h3><p>The premain needs access to some host <a href=https://marblerun.sh/docs/workflows/add-service/#step-3-start-your-service>environment variables for configuration</a>:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>loader.insecure__use_host_env = <span style=color:#f60>1</span>
</code></pre></div><p>The premain will remove all other variables before the actual application is launched, but there may still be risks. Don&rsquo;t use this on production until <a href=https://github.com/oscarlab/graphene/issues/2356>secure forwarding of host environment variables</a> will be available.</p><h3 id=uuid-file>uuid file</h3><p>The Marble must be able to store its uuid:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>sgx.allowed_files.uuid = <span style=color:#c30>&#34;file:uuid&#34;</span>
</code></pre></div><h3 id=remote-attestation>Remote attestation</h3><p>The Marble will send an SGX quote to the Coordinator for remote attestation:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>sgx.remote_attestation = <span style=color:#f60>1</span>
</code></pre></div><h3 id=enclave-size-and-threads>Enclave size and threads</h3><p>The premain process is written in Go. The enclave needs to have enough resources for the Go runtime:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>sgx.enclave_size = <span style=color:#c30>&#34;1024M&#34;</span>
sgx.thread_num = <span style=color:#f60>16</span>
</code></pre></div><p>If your application has high memory demands, you may need to increase the size even further.</p><h3 id=secret-files>Secret files</h3><p>A Marble&rsquo;s secrets, e.g. a certificate and private key, can be provisioned as files. Ideally, these would be placed in the Marble&rsquo;s in-memory filesystem. Graphene does not support this yet, but you can fall back on <em>Graphene Protected Files</em> instead:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>sgx.protected_files.cert = <span style=color:#c30>&#34;file:server.crt&#34;</span>
sgx.protected_files.privkey = <span style=color:#c30>&#34;file:server.key&#34;</span>
</code></pre></div><p>You can specify the files' content in the Marblerun Manifest:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>...
    <span style=color:#c30>&#34;Parameters&#34;</span><span style=color:#555>:</span> {
        <span style=color:#c30>&#34;Files&#34;</span><span style=color:#555>:</span> {
            <span style=color:#c30>&#34;/dev/attestation/protected_files_key&#34;</span><span style=color:#555>:</span> <span style=color:#c30>&#34;{{ hex .Marblerun.SealKey }}&#34;</span>,
            <span style=color:#c30>&#34;server.crt&#34;</span><span style=color:#555>:</span> <span style=color:#c30>&#34;{{ pem .Secrets.server_cert.Cert }}&#34;</span>,
            <span style=color:#c30>&#34;server.key&#34;</span><span style=color:#555>:</span> <span style=color:#c30>&#34;{{ pem .Secrets.server_cert.Private }}&#34;</span>
        }
    }
...
</code></pre></div><p>Note that Graphene requires to initialize the protected files key by writing it hex-encoded to the virtual <code>protected_files_key</code> device. This can be easily done through the above manifest configuration.</p><p>You can see this in action in the <a href=https://marblerun.sh/docs/examples/graphene/>nginx example</a>.</p><h2 id=troubleshooting>Troubleshooting</h2><h3 id=aesm_service-returned-error-30>aesm_service returned error: 30</h3><p>If you receive the following error message on launch:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>aesm_service returned error: 30
load_enclave() failed with error -1
</code></pre></div><p>Make sure you installed the Intel AESM ECDSA plugins on your machine. You can do this by installing the <code>libsgx-quote-dev</code> package mentioned in the requirements above.</p></article></div></div></div><footer class="bg-light text-center p-3"><div>Marblerun is brought to you by <a target=_blank href=https://edgeless.systems/>Edgeless Systems GmbH <img src=/img/ES_Symbol_black.svg class="verticle-align-middle ml-2" alt="Edgeless Systems GmbH Logo" width=14px class=mb-3></a></div></footer><script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx crossorigin=anonymous></script><script src=/js/main.js></script></body></html>