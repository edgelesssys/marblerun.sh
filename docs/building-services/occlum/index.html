<!doctype html><html><head><title>Occlum</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://marblerun.sh/docs/building-services/occlum/><link rel=stylesheet href=https://marblerun.sh/scss/bootstrap.min.6dfe43ec3c200a994a3cd357e5fca8a6453b3ad7ce879912d2ddfe17504e8bb8.css emotion=ðŸ¤©><script defer src=https://use.fontawesome.com/releases/v5.10.2/js/all.js></script><script async defer src=https://buttons.github.io/buttons.js></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="Marblerun - The control plane for confidential computing"><meta property="og:description" content="Marblerun makes it easy to deploy, scale, and verify your SGX-based apps on vanilla Kubernetes. Think Istio/Consul/Linkerd for confidential computing.â€‹"><meta property="og:image" content="https://www.marblerun.sh/img/social.png"><meta name=twitter:title content="Marblerun - The control plane for confidential computing"><meta name=twitter:description content="Marblerun makes it easy to deploy, scale, and verify your SGX-based apps on vanilla Kubernetes."><meta name=twitter:image content="https://www.marblerun.sh/img/social.png"><meta name=twitter:card content="Marblerun"></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top container-fluid"><a class=navbar-brand href=/><img src=/img/logo.png width=140px></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/docs/introduction/><i class="fas fa-book"></i>&nbsp;Docs</a></li><li class=nav-item><a class=nav-link href=/community><i class="fas fa-comments"></i>&nbsp;Community</a></li><li class=nav-item><a class=nav-link href=https://github.com/edgelesssys/marblerun><i class="fab fa-github"></i>&nbsp;GitHub</a></li><li class=nav-item><a href=/docs/getting-started/quickstart class="nav-link btn btn-primary ml-3">Get started â†’</a></li></ul></div></nav><div class="container my-3"><div class=row><div class="col-12 col-lg-3"><div class=docsSidebar><h1 class=my-3>Docs</h1><div class=mb-3><a href=/docs/introduction/ class=d-block><h6>Introduction</h6></a></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse1>Getting Started</h6><div class=collapse id=collapse1><a href=/docs/getting-started/quickstart/ class=d-block>Quickstart</a>
<a href=/docs/getting-started/concepts/ class=d-block>Concepts</a>
<a href=/docs/getting-started/coordinator/ class=d-block>Coordinator</a>
<a href=/docs/getting-started/marbles/ class=d-block>Marbles</a>
<a href=/docs/getting-started/cli/ class=d-block>CLI</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse2>Features</h6><div class=collapse id=collapse2><a href=/docs/features/attestation/ class=d-block>Attestation</a>
<a href=/docs/features/recovery/ class=d-block>Recovery</a>
<a href=/docs/features/secrets-management/ class=d-block>Secrets management</a>
<a href=/docs/features/auto-injection/ class=d-block>Kubernetes integration</a>
<a href=/docs/features/runtimes/ class=d-block>Supported runtimes</a>
<a href=/docs/features/planned-features/ class=d-block>Planned features</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse3>Deployment</h6><div class=collapse id=collapse3><a href=/docs/deployment/cloud/ class=d-block>Cloud</a>
<a href=/docs/deployment/on-prem/ class=d-block>On-premises</a>
<a href=/docs/deployment/kubernetes/ class=d-block>Kubernetes</a>
<a href=/docs/deployment/standalone/ class=d-block>Standalone</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse4>Core workflows</h6><div class=collapse id=collapse4><a href=/docs/workflows/define-manifest/ class=d-block>Defining a Manifest</a>
<a href=/docs/workflows/set-manifest/ class=d-block>Setting a Manifest</a>
<a href=/docs/workflows/add-service/ class=d-block>Adding a service</a>
<a href=/docs/workflows/verification/ class=d-block>Verifying a deployment</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse5>Additional workflows</h6><div class=collapse id=collapse5><a href=/docs/additional-workflows/monitoring/ class=d-block>Monitoring and logging</a>
<a href=/docs/additional-workflows/update-manifest/ class=d-block>Updating a Manifest</a>
<a href=/docs/additional-workflows/updates/ class=d-block>Updating a deployment</a>
<a href=/docs/additional-workflows/recover-coordinator/ class=d-block>Recovering the Coordinator</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse6>Building services</h6><div class="collapse show" id=collapse6><a href=/docs/building-services/ego/ class=d-block>EGo</a>
<a href=/docs/building-services/graphene/ class=d-block>Graphene</a>
<a href=/docs/building-services/occlum/ class="d-block text-primary">> Occlum</a></div></div><div class=mb-3><h6 class=cursor-pointer data-toggle=collapse data-target=#collapse7>Examples</h6><div class=collapse id=collapse7><a href=/docs/examples/helloworld/ class=d-block>Hello world</a>
<a href=/docs/examples/emojivoto/ class=d-block>Emoji voting</a>
<a href=/docs/examples/graphene/ class=d-block>Graphene-based examples</a>
<a href=/docs/examples/occlum/ class=d-block>Occlum-based examples</a></div></div><div class=mb-3><a href=/docs/changelog/ class=d-block><h6>Changelog</h6></a></div></div></div><div class="col-12 col-lg-9"><article><h1 id=building-a-service-occlum>Building a service: Occlum</h1><p>Running an Occlum app with Marblerun requires some changes to its manifest.</p><h2 id=requirements>Requirements</h2><p>Set up an environment to create Occlum images. For an easy start, we recommend that you use either <a href=https://hub.docker.com/r/occlum/occlum>the official Occlum Docker image</a> or <a href=https://github.com/edgelesssys/marblerun/blob/master/samples/occlum-hello/Dockerfile>use our provided Dockerfile</a>. For a working DCAP remote attestation environment we recommend <a href=https://marblerun.sh/docs/deployment/cloud/>our cloud deployment guide</a>.</p><p>To build your service, you can start with Occlum&rsquo;s <a href=https://github.com/occlum/occlum#introduction>Introduction</a> to get your application up and running, and then come back here to adapt it for use with Marblerun.</p><h2 id=configuration>Configuration</h2><h3 id=premain-executable>Premain executable</h3><p>Add our prebuilt <a href=https://github.com/edgelesssys/marblerun/releases/download/latest/premain-occlum>premain-occlum</a> executable to your Occlum image, e.g., by copying it to <code>image/bin/premain-occlum</code>. By default, Occlum restricts executable files to the <code>/bin</code> directory. If you placed the <code>premain-occlum</code> binary to a different path, you need to adjust this setting accordingly.</p><p>Finally, define the original entry point for your Occlum instance as the first <code>Argv</code> parameter for your Marble in Marblerun&rsquo;s <code>manifest.json</code>. See <a href=https://marblerun.sh/docs/workflows/define-manifest/>Defining a Manifest</a> for more information on how to define the <code>Argv</code> parameters. This lets Marblerun launch your application after it succeeded in authenticating with the Coordinator and provides entrypoint pinning similar to the one offered in <code>Occlum.json</code>.</p><h3 id=environment-variables>Environment variables</h3><p>The Marble needs to retrieve the Marblerun specific configuration parameters via environment variables, as <a href=https://marblerun.sh/docs/workflows/add-service/>described under Step 3 in &ldquo;Adding a service&rdquo;</a>.</p><p>To pass environment variables to the enclave, Occlum requires them to be specified in the <code>env</code> section in <code>Occlum.json</code>.</p><p>You can provide default (hardcoded) values under <code>default</code>, and you may also define them additionally as <code>untrusted</code> in case you want to allow changes to the Marble configuration after build time.</p><p>For example, this configuration:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#c30>&#34;env&#34;</span><span style=color:#555>:</span> {
    <span style=color:#c30>&#34;default&#34;</span><span style=color:#555>:</span> [
        <span style=color:#c30>&#34;OCCLUM=yes&#34;</span>,
        <span style=color:#c30>&#34;EDG_MARBLE_COORDINATOR_ADDR=localhost:2001&#34;</span>,
        <span style=color:#c30>&#34;EDG_MARBLE_TYPE=hello&#34;</span>,
        <span style=color:#c30>&#34;EDG_MARBLE_UUID_FILE=uuid&#34;</span>,
        <span style=color:#c30>&#34;EDG_MARBLE_DNS_NAMES=localhost&#34;</span>
    ],
    <span style=color:#c30>&#34;untrusted&#34;</span><span style=color:#555>:</span> [
        <span style=color:#c30>&#34;EDG_MARBLE_COORDINATOR_ADDR&#34;</span>,
        <span style=color:#c30>&#34;EDG_MARBLE_TYPE&#34;</span>,
        <span style=color:#c30>&#34;EDG_MARBLE_UUID_FILE&#34;</span>,
        <span style=color:#c30>&#34;EDG_MARBLE_DNS_NAMES&#34;</span>
    ]
},
</code></pre></div><p>will allow you both to embed the expected default values during build time, but also let the user/host system change them during run time when a non-default Coordinator configuration is used.</p><h3 id=resource-limits>Resource limits</h3><p>The premain process is written in Go. The enclave needs to have enough resources for the Go runtime, plus additional memory to launch your application.</p><p>We recommend starting with the following values which should work fine for light-wight to medium memory demanding applications:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#c30>&#34;user_space_size&#34;</span><span style=color:#555>:</span> <span style=color:#c30>&#34;2048MB&#34;</span>,
<span style=color:#c30>&#34;default_mmap_size&#34;</span><span style=color:#555>:</span> <span style=color:#c30>&#34;900MB&#34;</span>
<span style=color:#c30>&#34;max_num_of_threads&#34;</span><span style=color:#555>:</span> <span style=color:#f60>64</span>
</code></pre></div><p>In case you are running into issues with memory demands, check out the <a href=https://github.com/occlum/occlum/blob/master/docs/resource_config_guide.md>Resource Configuration Guide</a> provided by the Occlum team to debug and resolve issues related to resource limits.</p><h2 id=troubleshooting>Troubleshooting</h2><h3 id=fatal-error-failed-to-reserve-page-summary-memory><code>fatal error: failed to reserve page summary memory</code></h3><p>If you receive this error during the launch of your Occlum image, make sure you allocated enough memory in <code>Occlum.json</code> <a href=#resource-limits>as described above</a>. The most important parameters are <code>user_space_size</code> and <code>default_mmap_size</code>.</p><h3 id=error-the-entrypoint-does-not-seem-to-exist><code>ERROR: The entrypoint does not seem to exist</code></h3><p>If you receive the following error message after the Marblerun premain executed:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>ERROR: The entrypoint does not seem to exist: &#39;/bin/your_application&#39;
Please make sure that you define a valid entrypoint in your manifest (for example: /bin/hello_world).
panic: &#34;invalid entrypoint definition in argv[0]&#34;
</code></pre></div><p>or alternatively:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>ERROR: Failed to spawn the target process.
Did you specify the correct target application in the Marblerun manifest as argv[0]?
Have you allocated enough memory?
panic: posix_spawn failed with error code -1
</code></pre></div><p>Make sure you specified the correct file name of your target application. For the latter error message, also make sure enough memory is allocated. To find out the specific reason for why this error is occurring, you can set the environment variable <code>OCCLUM_LOG_LEVEL=error</code> by appending it in front of your run command like this:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#033>OCCLUM_LOG_LEVEL</span><span style=color:#555>=</span>error make run
</code></pre></div><p>or:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#033>OCCLUM_LOG_LEVEL</span><span style=color:#555>=</span>error occlum run /bin/premain-occlum
</code></pre></div><p>Search for <code>SpawnMusl</code>. This entry will contain the error encountered when spawning your application from Marblerun&rsquo;s premain process.</p><h3 id=error-returned-from-the-p_sgx_get_quote_config-api>Error returned from the p_sgx_get_quote_config API</h3><p>If Occlum crashes during the quote generation with the following error message:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[get_platform_quote_cert_data ../qe_logic.cpp:346] Error returned from the p_sgx_get_quote_config API. 0xe019
thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;assertion failed: `(left == right)`
left: `SGX_QL_SUCCESS`,
right: `SGX_QL_NETWORK_ERROR`: fail to launch QE&#39;, src/util/sgx/dcap/quote_generator.rs:22:13
</code></pre></div><p>You might need to check the DCAP configuration on your system. Note that when using the Docker image, the local Intel DCAP configuration needs to be correctly set from <strong>inside the container.</strong></p><p>If you use an Azure Confidential Computing machine, you can use our <a href=https://github.com/edgelesssys/marblerun/blob/master/samples/occlum-hello/Dockerfile>provided Dockerfile</a> which patches the official Occlum image to use the Azure DCAP client, which handles the configuration automatically.</p><p>For other DCAP setups, please consult the documentation of your Intel Provisioning Certificate Caching Service (PCCS) service running locally or remotely.</p></article></div></div></div><footer class="bg-light text-center p-3"><div>Marblerun is brought to you by <a target=_blank href=https://edgeless.systems/>Edgeless Systems GmbH <img src=/img/ES_Symbol_black.svg class="verticle-align-middle ml-2" alt="Edgeless Systems GmbH Logo" width=14px class=mb-3></a></div></footer><script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx crossorigin=anonymous></script><script src=/js/main.js></script></body></html>