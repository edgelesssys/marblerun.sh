<!DOCTYPE html>
<html>

<head>
	<title>Recovery</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="canonical" href="https://marblerun.sh/docs/features/recovery/" />
	
	<link rel="stylesheet" href="https://marblerun.sh/scss/bootstrap.min.05e88624b497548722fef3538d7efdf80b0045261b068a51fbcf9b25d5fa5298.css" emotion="ðŸ¤©">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">



<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top container-fluid">
  <a class="navbar-brand" href="/">
    <img src="/img/logo.png" width="140px">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link " href="/docs/introduction/"><i
            class="fa fa-book"></i> Docs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link " href="/community"><i
            class="fa fa-commenting"></i>
          Community</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#"> <i class="fa fa-github"></i> Github</a>
      </li>
      <li class="nav-item">
        <a href="#0" class="nav-link btn btn-primary ml-3">Get Started â†’</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container my-3">
  <div class="mb-3">
    <div id="breadcrumbs">
  <a href="/">Home</a>
  
  
  
  
  / <a href="/docs">Docs</a>
  
  
  
  / <a href="/features">Features</a>
  
  
  
  / <a href="/recovery">Recovery</a>
  
  
  
  
</div>
  </div>
  <h1 class="my-3">Docs</h1>
  <div class="row">
    <div class="col-12 col-lg-3">
      <div class="docsSidebar">
  
  
  
  <div class="mb-3">
    
    <a href="https://marblerun.sh/docs/introduction/" class="d-block">Introduction</a>
    
  </div>
  
  <div class="mb-3">
    
    <h6>Getting Started</h6>
    
    <a href="https://marblerun.sh/docs/getting-started/quickstart/" class="d-block pl-3">Quickstart</a>
    
    <a href="https://marblerun.sh/docs/getting-started/confidential-computing/" class="d-block pl-3">Confidential Computing</a>
    
    <a href="https://marblerun.sh/docs/getting-started/service-mesh/" class="d-block pl-3">Service Mesh</a>
    
    <a href="https://marblerun.sh/docs/getting-started/overview/" class="d-block pl-3">Overview</a>
    
    
  </div>
  
  <div class="mb-3">
    
    <h6>Features</h6>
    
    <a href="https://marblerun.sh/docs/features/attestation/" class="d-block pl-3">Attestation</a>
    
    <a href="https://marblerun.sh/docs/features/recovery/" class="d-block pl-3">Recovery</a>
    
    <a href="https://marblerun.sh/docs/features/secrets-management/" class="d-block pl-3">Secrets management</a>
    
    <a href="https://marblerun.sh/docs/features/planned-features/" class="d-block pl-3">Planned features</a>
    
    
  </div>
  
  <div class="mb-3">
    
    <h6>Tasks</h6>
    
    <a href="https://marblerun.sh/docs/tasks/deploy/" class="d-block pl-3">Deploy Marblerun to your cluster</a>
    
    <a href="https://marblerun.sh/docs/tasks/set-manifest/" class="d-block pl-3">Setting a Manifest</a>
    
    <a href="https://marblerun.sh/docs/tasks/add-service/" class="d-block pl-3">Adding a Service</a>
    
    <a href="https://marblerun.sh/docs/tasks/verification/" class="d-block pl-3">Client-Side verification</a>
    
    <a href="https://marblerun.sh/docs/tasks/updates/" class="d-block pl-3">Deployment updates</a>
    
    <a href="https://marblerun.sh/docs/tasks/monitoring/" class="d-block pl-3">Monitoring and logging</a>
    
    
  </div>
  
  <div class="mb-3">
    
    <h6>Examples</h6>
    
    <a href="https://marblerun.sh/docs/examples/helloworld/" class="d-block pl-3">Hello World</a>
    
    <a href="https://marblerun.sh/docs/examples/emojivoto/" class="d-block pl-3">Confidential Emoji Voting</a>
    
    
  </div>
  
  <div class="mb-3">
    
    <a href="https://marblerun.sh/docs/changelog/" class="d-block">Changelog</a>
    
  </div>
  
  
  
</div>
    </div>
    <div class="col-12 col-lg-9">
      <article>
        <h1 id="recovery">Recovery</h1>
<p>Persistent storage for confidential applications in the cloud requires a bit of attention.
Unfortunately, SGX sealing keys are unique to a single CPU, which means using the default SGX sealing methods has some caveats.
For example, sealing data while running on one node could mean the data can&rsquo;t be unsealed when running on another node later on.
The Coordinator provides Marbles with virtual sealing keys making persistence straightforward for your applications.
By using the virtual sealing key data can be unsealed independently of the nodes the app is running on.</p>
<p>Unfortunately, the Coordinator itself must keep its state persistent somehow. When being pinned to a single node the default SGX sealing methods are used. However, when the Coordinator needs to be shifted to  another node or another cluster a manual step is required to ensure the Coordinator&rsquo;s state can be recovered.
Therefore, the manifest allows specifying a recovery key.</p>
<h2 id="key-generation">Key Generation</h2>
<p>Marblerun allows specifying a PKIX PEM-encoded RSA Public Key in the manifest. Such key can be generated with the help of OpenSSL:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">openssl genrsa -out private_key.pem <span style="color:#ae81ff">4096</span>
openssl rsa -in private_key.pem -outform PEM -pubout -out public_key.pem
</code></pre></div><p>In the manifest, the PEM is stored as <code>RecoveryKey</code>. See <a href="tasks/set-manifest.md">Setting a Manifest</a> as an example. To preserve the new lines correctly, you can use the following command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">awk <span style="color:#e6db74">&#39;NF {sub(/\r/, &#34;&#34;); printf &#34;%s\\n&#34;,$0;}&#39;</span> public_key.pem
</code></pre></div><p>When setting a manifest through the <code>/manifest</code> API endpoint, you will receive a JSON reply including a recovery secret, encrypted with your RSA public key. The reply will look like this, with <code>[base64]</code> as your encrypted recovery secret.</p>
<p><code>{&quot;EncryptionKey&quot;:&quot;[base64]&quot;}</code></p>
<p><strong>It is important that you keep this value stored somewhere safe. Without it, you will not be able to perform a recovery step in case the SGX seal key changed.</strong></p>
<h2 id="restore-state">Restore State</h2>
<p>If the Coordinator finds a sealed state during its startup which it is unable to unseal using the current SGX seal key it will wait for further instructions.
You have to options on how to proceed:</p>
<ol>
<li>
<p>Recover the sealed state by uploading the recovery secret</p>
<p>The recovery secret can be uploaded through the <code>/recover</code> client API endpoint. In order to do so a client needs to first extract the encrypted secret by decrypting it with the corresponding private key:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">base64 -d recovery_key_encrypted_base64 &gt; recovery_key_encrypted
openssl pkeyutl -inkey private_key.pem -in recovery_key_encrypted -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256 -decrypt -out recovery_key_decrypted
</code></pre></div><p>The extracted secret can then be uploaded via the client API.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -k -X POST --data-binary @recovery_key_decrypted <span style="color:#e6db74">&#34;https://</span>$MARBLERUN<span style="color:#e6db74">/recover&#34;</span>
</code></pre></div><p>If the recovery worked correctly, the Coordinator should apply the sealed state again without returning an error. In case the Coordinator was not able to restore the state with the uploaded key, an error will be returned in the logs and the <code>/recover</code> endpoint will stay open for further interaction.</p>
</li>
<li>
<p>Dismiss the sealed state by uploading a new manifest</p>
<p>In case there is no desire to recover the old state it can simply be dismissed by <a href="tasks/set-manifest.md">uploading a new manifest</a>.
<em>Note</em> that if a new manifest is uploaded to the server, the old state will be <em>overwritten</em> on disk and the <code>/recover</code> endpoint will not be available anymore.</p>
</li>
</ol>

      </article>
    </div>
  </div>
</div>

<footer class="bg-light text-center p-3">

	<div>Marblerun is brought to you by <a target="_blank" href="https://edgeless.systems/">Edgeless Systems GmbH <img
				src="/img/ES_Symbol_black.svg" class="verticle-align-middle ml-2" alt="Edgeless Systems GmbH Logo" width="14px"
				class="mb-3"></a>
	</div>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
	integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<script src="/js/main.js"></script>
</body>

</html>