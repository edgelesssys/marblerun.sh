---
title: "Managing Secrets"
date: 2021-06-17T13:36:38+02:00
draft: false
weight: 7
---

# Managing Secrets

In some cases a user might need access to a secret generated by Marblerun, or they might instead want to set the secret themselves.

Additionally not all secret data comes in the form of symmetric-keys and certificates. For example an application can require an access-token to establish a secure connection to some service.
While setting this information directly in the Manifest is an option, this would also expose potentially confidential information to everyone with access to the Manifest.

To circumvent this issue, Marblerun allows users with write permission for specific secrets, to uploade secret data after the Manifest has already been set.
Similarly Marblerun also allows users with read permission for specific secrets, to retrieve those secrets from the coordinator.
For this the Coordinator exposes the `/secrets` endpoint over its HTTP-REST interface.


## Reading a secret

Marblerun returns secrets over the client API as JSON strings of their internal structure. 
Using the CLI, this output is formatted into an easily reabale form, or directly saved to a file.
Note that for this operation, you need to specify one of your defined `Users` certificates as a TLS client certificate, combined with the according private key.

For example, to request a secret named `symmetric_key_shared` one would use the command:
```bash
marblerun secret get symmetric_key_shared $MARBLERUN --cert=admin-cert.pem --key=admin-key.pem --era-config=era.json
```
This then returns the secret, if the user is permitted to read the secret:
```
symmetric_key_shared:
	Type:          symmetric-key
	UserDefined:   false
	Size:          128
	Key:           uVGpoJZTRICLccJiVNt9jA==
```

## Setting a secret

Setting a secret requires a user to upload a JSON file containing the secret, and for the secret to be marked as `UserDefined` in the manifest.
Each entry is labeled by the name of the secret and defines either just `Key` or `Cert` and optionally `Private`.
The values one needs to set depend on the type of secret:

* For the types `cert-rsa`, `cert-ecdsa` and `cert-ed25519`:
  * `Cert`: A PEM encoded certificate.
    To preserve newlines correctly set `Cert` to the output of the following command:
    ```bash
    echo -n $(cat <secret_certificate>.pem | sed '1,1d;$ d' | awk 'NF {sub(/\r/, ""); printf "%s\\n",$0;}')
    ```
  * `Private`: A PEM encoded private key. This may be omitted.
    To preserve newlines correctly set `Private` to the output of the following command:
    ```bash
    echo -n $(cat <secret_private_key>.pem | sed '1,1d;$ d' | awk 'NF {sub(/\r/, ""); printf "%s\\n",$0;}')
    ```
* For type `symmetric-key`:
  * Key: a base64 encoded key, with length matching the size defined in the original manifest
* For the type `plain`:
  * `Key`: arbitrary data in base64 encoding. This may be a key of unspecified length, a confidential config file, or any kind of data only some Marbles and/or users should have access to.

The following gives an example for a file to set the secrets `user_defined_symmetric_key`, `user_defined_cert`, and `generic_secret`:

```javascript
{
  "user_defined_symmetric_key": {
    "Key": "AAECAwQFBgcICQoLDA0ODw=="
  },
  "user_defined_cert": {
    "Cert": "MIIBjDCCATOgAwIBAgICBTkwCgYIKoZIzj0EAwIwMjEwMC4GA1UEAxMnTWFyYmxlcnVuIENvb3JkaW5hdG9yIC0gSW50ZXJtZWRpYXRlIENBMB4XDTIxMDYxNTA4NTY0M1oXDTIxMDYyMjA4NTY0M1owLTEcMBoGA1UEAxMTTWFyYmxlcnVuIFVuaXQgVGVzdDENMAsGA1UEBRMEMTMzNzAqMAUGAytlcAMhAEPOc066G5XmvLizOKTENSR+U9lv3geZ0/a2+XkhJRvDo20wazAOBgNVHQ8BAf8EBAMCAoQwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMAwGA1UdEwEB/wQCMAAwLAYDVR0RBCUwI4IJbG9jYWxob3N0hwR/AAABhxAAAAAAAAAAAAAAAAAAAAABMAoGCCqGSM49BAMCA0cAMEQCIGOlRcynaPaj/flSr2ZEvmTmhuvtmTb4QkwPFtxFz3EJAiB77ijxAcJNxPKcKmgMB+c8NORC+6N/St2iP/oX/vqQvg==",
    "Private": "MC4CAQAwBQYDK2VwBCIEIPlmAOOhAStk8ytxzvekPr8zLaQa9+lxnHK+CizDrMds"
  },
  "generic_secret": {
    "Key": "SGVsbG8gZnJvbSB0aGUgTWFyYmxlcnVuIERvY3MhCg=="
  }
}
```

This file can then be uploaded using the CLI, once again requiring a `Users` certificate and matching private key:
```bash
marblerun secret set secret_file.json $MARBLERUN --cert=admin-cert.pem --key=admin-key.pem --era-config=era.json
```
The secrets will then be available to Marbles or other users over the REST-API. If the user lacks permission to set one of the secrets, or a secret the user tried to upload was malformed an error occurs instead.
